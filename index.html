<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NASZEX CLOUD - RMS ENTERPRISE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="icon" type="image/png" href="logo.png">
    
    <style>
        :root { --primary: #0f172a; --accent: #ef4444; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc;
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Font Utilities */
        .font-num { font-family: 'Inter', sans-serif; }

        /* Super Smooth Animations */
        .modal-wrapper {
            transition: transform 0.25s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.25s ease-out;
            transform: translateY(110%); opacity: 0; pointer-events: none;
        }
        .modal-wrapper.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .fade-enter { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .view-section { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .view-section.active { display: block; opacity: 1; }
        
        /* Glass UI */
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.6); }
        .tab-active { background: #0f172a !important; color: #fff !important; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        
        /* Gradients */
        .grad-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .grad-green { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .grad-red { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }
        .grad-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        
        /* Input Styles */
        input, select, textarea { font-size: 16px !important; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* Timeline Graphics */
        .timeline-item { position: relative; padding-left: 28px; padding-bottom: 24px; border-left: 2px solid #e2e8f0; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; box-shadow: 0 0 0 2px #fff; transition: 0.3s; }
        .timeline-item.active .timeline-dot { background: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); transform: scale(1.2); }
        .timeline-item.active { border-left-color: #10b981; }

        /* Floating Label Input */
        .float-input-group { position: relative; }
        .float-input-group input, .float-input-group select { padding-top: 1.25rem; padding-bottom: 0.5rem; }
        .float-input-group label { position: absolute; top: 0.25rem; left: 0.75rem; font-size: 0.65rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; pointer-events: none; transition: 0.2s; }
    </style>
</head>
<body class="min-h-screen pb-28">

    <nav class="sticky top-0 z-40 glass-nav px-5 py-3">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-950 rounded-xl flex items-center justify-center shadow-lg shadow-slate-900/10">
                    <span class="text-white font-black text-[12px] italic tracking-tighter">NX</span>
                </div>
                <div>
                    <h1 class="text-[12px] font-black italic uppercase tracking-[0.25em] text-slate-900 leading-none">NASZEX <span class="text-red-600">CLOUD</span></h1>
                    <p class="text-[7px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-1.5 leading-none pl-0.5">RMS Premium v5.1</p>
                </div>
            </div>
            <button onclick="refreshData()" class="w-10 h-10 flex items-center justify-center bg-white rounded-xl text-slate-400 shadow-sm border border-slate-200 active:scale-90 transition-transform">
                <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
            </button>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-6">
        
        <main id="dashboardView" class="view-section active space-y-6">
            <div class="grid grid-cols-3 gap-3">
                <div class="grad-green rounded-2xl p-4 shadow-xl shadow-emerald-900/10 text-center relative overflow-hidden">
                    <p class="text-[14px] font-black text-white italic tracking-tight font-num">RM <span id="stat-month-paid">0</span></p>
                    <p class="text-[7px] font-bold text-emerald-100 uppercase mt-1 tracking-widest">Collected</p>
                </div>
                <div class="grad-red rounded-2xl p-4 shadow-xl shadow-rose-900/10 text-center relative overflow-hidden">
                    <p class="text-[14px] font-black text-white italic tracking-tight font-num">RM <span id="stat-month-pending">0</span></p>
                    <p class="text-[7px] font-bold text-rose-100 uppercase mt-1 tracking-widest">Unpaid</p>
                </div>
                <div class="grad-blue rounded-2xl p-4 shadow-xl shadow-blue-900/10 text-center relative overflow-hidden">
                    <p class="text-[14px] font-black text-white italic tracking-tight font-num"><span id="stat-month-jobs">0</span></p>
                    <p class="text-[7px] font-bold text-blue-100 uppercase mt-1 tracking-widest">Active Jobs</p>
                </div>
            </div>

            <div class="relative group">
                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="SEARCH RECORD..." 
                       class="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl text-xs font-bold shadow-sm focus:ring-2 focus:ring-slate-900/10 outline-none transition-all placeholder:text-slate-300 placeholder:tracking-widest font-num">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
            </div>

            <div class="flex p-1.5 bg-slate-200/60 rounded-xl gap-1.5">
                <button onclick="filterInvoices('all')" id="f-all" class="flex-1 py-2.5 rounded-lg text-[9px] font-black uppercase transition-all tab-active shadow-sm text-slate-800">Semua</button>
                <button onclick="filterInvoices('paid')" id="f-paid" class="flex-1 py-2.5 rounded-lg text-[9px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Paid</button>
                <button onclick="filterInvoices('outstanding')" id="f-pending" class="flex-1 py-2.5 rounded-lg text-[9px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Unpaid</button>
            </div>

            <div id="invoiceContainer" class="space-y-3 pb-8 min-h-[300px]"></div>
        </main>

        <main id="reportsView" class="view-section">
            <div id="dataMenu" class="space-y-4 pt-2">
                <button onclick="openSubReport('performance')" class="w-full bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 flex items-center justify-between group active:scale-95 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600"><i data-lucide="bar-chart-2" class="w-6 h-6"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase tracking-tight text-slate-900">Performance</h3>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Job Volume & Trends</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>

                <button onclick="openSubReport('profit')" class="w-full bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 flex items-center justify-between group active:scale-95 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase tracking-tight text-slate-900">Net Profit</h3>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Revenue vs Cost</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>
            </div>

            <div id="performanceContainer" class="sub-view-hidden hidden">
                <button onclick="closeSubReport()" class="mb-4 flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i data-lucide="arrow-left" class="w-3 h-3"></i> Back</button>
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr><th class="pl-6 py-4 text-[9px] font-black uppercase text-slate-400">Month</th><th class="text-center text-[9px] font-black uppercase text-slate-400">Jobs</th><th class="pr-6 text-right text-[9px] font-black uppercase text-slate-400">Total</th></tr>
                        </thead>
                        <tbody id="reportTableBody" class="text-slate-800 text-[11px] font-bold font-num"></tbody>
                    </table>
                </div>
            </div>

            <div id="profitContainer" class="sub-view-hidden hidden">
                <button onclick="closeSubReport()" class="mb-4 flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i data-lucide="arrow-left" class="w-3 h-3"></i> Back</button>
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                     <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr><th class="pl-6 py-4 text-[9px] font-black uppercase text-slate-400">Month</th><th class="text-center text-[9px] font-black uppercase text-rose-400">Cost</th><th class="pr-6 text-right text-[9px] font-black uppercase text-emerald-500">Nett</th></tr>
                        </thead>
                        <tbody id="profitTableBody" class="text-[11px] font-bold font-num"></tbody>
                        <tfoot class="bg-slate-900 text-white">
                            <tr><td class="pl-6 py-4 text-[9px] uppercase font-bold text-white/50">Nett Profit</td><td colspan="2" id="total-net-profit" class="text-right pr-6 py-4 text-lg font-black italic font-num">RM 0</td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </main>

        <main id="toolsView" class="view-section">
            <div id="toolsMenu" class="space-y-4 pt-2">
                <button onclick="openSubTool('receipt')" class="w-full grad-dark p-6 rounded-[2rem] shadow-xl shadow-slate-900/20 text-white flex items-center justify-between active:scale-95 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center"><i data-lucide="printer" class="w-6 h-6"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase tracking-tight">Smart Receipt</h3>
                            <p class="text-[9px] text-slate-300 font-bold uppercase tracking-wider mt-0.5">PDF & Direct WhatsApp</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-white/50"></i>
                </button>

                <button onclick="openSubTool('track')" class="w-full bg-white border border-slate-200 p-6 rounded-[2rem] shadow-sm text-slate-900 flex items-center justify-between active:scale-95 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center"><i data-lucide="radar" class="w-6 h-6"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase tracking-tight">Live Tracker</h3>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Check Status by Phone</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>
            </div>

            <div id="toolReceiptContainer" class="sub-view-hidden hidden">
                <button onclick="closeSubTool()" class="mb-4 flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i data-lucide="arrow-left" class="w-3 h-3"></i> Back</button>
                <div class="bg-white rounded-[2.5rem] p-8 shadow-xl shadow-slate-200/50 border border-slate-100 text-center space-y-6">
                    <div class="w-16 h-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center mx-auto mb-2 shadow-lg"><i data-lucide="printer" class="w-8 h-8"></i></div>
                    <div class="space-y-4">
                         <div class="float-input-group text-left">
                            <input type="tel" id="toolReceiptPhone" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 font-bold outline-none focus:border-slate-400 font-num">
                            <label>Customer Phone No.</label>
                         </div>
                         <div class="grid grid-cols-1 gap-3">
                            <button onclick="handleTools('whatsapp')" class="w-full bg-[#25D366] text-white p-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-green-500/20 active:scale-95 flex items-center justify-center gap-2 transition-transform"><i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp</button>
                            <button onclick="handleTools('pdf')" class="w-full bg-slate-800 text-white p-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg active:scale-95 flex items-center justify-center gap-2 transition-transform"><i data-lucide="download" class="w-4 h-4"></i> Download PDF</button>
                         </div>
                    </div>
                </div>
            </div>

            <div id="toolTrackContainer" class="sub-view-hidden hidden">
                <button onclick="closeSubTool()" class="mb-4 flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i data-lucide="arrow-left" class="w-3 h-3"></i> Back</button>
                <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-slate-100 space-y-6">
                     <div class="relative">
                        <input type="tel" id="toolTrackPhone" placeholder="Search Phone No..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 pr-20 text-sm font-black outline-none focus:ring-2 focus:ring-orange-500/20 font-num">
                        <button onclick="trackStatus()" class="absolute right-2 top-2 bottom-2 bg-orange-500 text-white px-4 rounded-xl font-bold text-[10px] uppercase active:scale-95 transition-transform">Check</button>
                     </div>
                     
                     <div id="trackResult" class="hidden fade-enter">
                         <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 mb-6">
                             <div class="flex justify-between items-start">
                                 <h4 id="trName" class="font-black text-xs uppercase text-slate-900"></h4>
                                 <span id="trNo" class="text-[9px] font-bold bg-slate-200 px-2 py-0.5 rounded text-slate-500 font-num"></span>
                             </div>
                             <p id="trDevice" class="text-[10px] text-slate-500 font-bold mt-1"></p>
                         </div>
                         <div class="space-y-0 px-2" id="timelineContainer"></div>
                     </div>
                     
                     <div id="trackEmpty" class="text-center py-12 opacity-40">
                         <i data-lucide="radar" class="w-10 h-10 mx-auto text-slate-300 mb-2"></i>
                         <p class="text-[9px] font-black text-slate-400 uppercase">System Ready to Trace</p>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 glass-nav px-6 py-2 pb-8 safe-bottom">
        <div class="max-w-md mx-auto grid grid-cols-4 gap-2 items-center">
            <button onclick="showPage('dashboard')" id="nav-dash" class="flex flex-col items-center gap-1 text-red-600 active:scale-90 transition-transform duration-200">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase">Home</span>
            </button>
            <button onclick="openAddModal()" class="flex flex-col items-center justify-end -mt-10 group">
                <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center text-white shadow-xl shadow-slate-900/40 border-[6px] border-[#f8fafc] group-active:scale-90 transition-transform duration-200">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </div>
            </button>
            <button onclick="showPage('reports')" id="nav-report" class="flex flex-col items-center gap-1 text-slate-400 active:scale-90 transition-transform duration-200">
                <i data-lucide="pie-chart" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase">Data</span>
            </button>
            <button onclick="showPage('tools')" id="nav-tools" class="flex flex-col items-center gap-1 text-slate-400 active:scale-90 transition-transform duration-200">
                <i data-lucide="wrench" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase">Tools</span>
            </button>
        </div>
    </div>

    <div id="invoiceModal" class="fixed inset-0 z-50 bg-slate-950/60 backdrop-blur-sm hidden modal-wrapper flex-col justify-end sm:justify-center">
        <div class="bg-[#f8fafc] w-full max-w-md mx-auto h-[92vh] sm:h-[85vh] sm:rounded-[2rem] rounded-t-[2.5rem] shadow-2xl flex flex-col overflow-hidden relative">
            
            <div class="px-6 py-5 bg-white border-b border-slate-200/50 flex justify-between items-center shrink-0">
                <div>
                    <h2 id="modalTitle" class="text-[14px] font-black uppercase tracking-tight text-slate-900">Initiate Record</h2>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Job Details</p>
                </div>
                <button onclick="toggleModal(false)" class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 active:bg-slate-200"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <input type="hidden" id="editId">
                
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                    <div class="float-input-group">
                        <input type="text" id="custName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 font-bold outline-none focus:bg-white focus:border-slate-400 transition-colors">
                        <label>Customer Name</label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="float-input-group">
                            <input type="tel" id="custPhone" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 font-bold outline-none focus:bg-white focus:border-slate-400 font-num transition-colors">
                            <label>Phone No.</label>
                        </div>
                        <div class="float-input-group">
                            <select id="warranty" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 font-bold outline-none focus:bg-white focus:border-slate-400 transition-colors">
                                <option value="No Warranty">No Warranty</option>
                                <option value="3 Days">3 Days</option>
                                <option value="1 Week">1 Week</option>
                                <option value="1 Month">1 Month</option>
                                <option value="3 Months">3 Months</option>
                            </select>
                            <label>Warranty</label>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-end px-1">
                        <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Repair Items</h4>
                        <button onclick="addRow()" class="text-[9px] font-bold text-white bg-slate-900 px-3 py-1.5 rounded-lg uppercase tracking-wide active:scale-95 shadow-lg shadow-slate-900/20 transition-transform">
                            + Add Item
                        </button>
                    </div>
                    <div id="itemRowsContainer" class="space-y-3 pb-20"></div>
                </div>
            </div>

            <div class="p-5 bg-white border-t border-slate-200 shrink-0 safe-bottom">
                <div class="flex justify-between items-center mb-4">
                    <select id="initialStatus" class="bg-slate-100 text-slate-700 py-2 px-3 rounded-lg text-[10px] font-black uppercase outline-none">
                        <option value="outstanding">Unpaid</option>
                        <option value="paid">Paid</option>
                    </select>
                    <div class="text-right">
                        <p class="text-[8px] font-bold text-slate-400 uppercase mb-0.5">Grand Total</p>
                        <p class="text-2xl font-black text-slate-900 italic leading-none font-num">RM <span id="grandTotal">0.00</span></p>
                    </div>
                </div>
                <button onclick="saveAndGenerate()" id="btnSave" class="w-full grad-dark text-white py-4 rounded-xl font-black uppercase text-[11px] tracking-[0.2em] shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    Save Record <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex-col justify-end">
        <div class="bg-white rounded-t-[2.5rem] w-full p-6 pb-10 shadow-2xl space-y-5 safe-bottom">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto"></div>
            <div class="text-center">
                 <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Manage Job</p>
                 <h2 id="actionTargetName" class="font-black text-lg uppercase text-slate-900 italic tracking-tight mt-1 truncate px-4"></h2>
            </div>
            
            <div class="bg-slate-50 p-1 rounded-2xl border border-slate-200">
                <select id="updateRepairStatus" onchange="updateLiveStatus(activeId, this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-black outline-none shadow-sm text-slate-700">
                    <option value="Received">1. Received</option>
                    <option value="Waiting">2. Waiting</option>
                    <option value="Diagnosis">3. Diagnosis</option>
                    <option value="Repairing">4. Repairing</option>
                    <option value="Ready">5. Ready</option>
                    <option value="Collected">6. Collected</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="btnToggleStatus" class="col-span-2 p-4 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase shadow-lg flex justify-between items-center px-6 active:scale-95 transition-transform">
                    <span>Toggle Payment</span><i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                </button>
                <button onclick="handleAction('getlink')" class="p-4 bg-blue-50 text-blue-600 rounded-xl font-black text-[9px] uppercase border border-blue-100 flex justify-center items-center gap-2 active:scale-95 transition-transform">
                    <i data-lucide="link" class="w-4 h-4"></i> Copy Link
                </button>
                <button onclick="handleAction('edit')" class="p-4 bg-amber-50 text-amber-600 rounded-xl font-black text-[9px] uppercase border border-amber-100 flex justify-center items-center gap-2 active:scale-95 transition-transform">
                    <i data-lucide="edit-3" class="w-4 h-4"></i> Modify
                </button>
            </div>
             <button onclick="handleAction('delete')" class="w-full p-4 text-rose-500 font-black text-[10px] uppercase border border-rose-100 rounded-xl active:scale-95 transition-transform">
                Delete Record
            </button>
            <button onclick="closeActionMenu()" class="w-full py-3 text-[10px] font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIG & INIT ---
        lucide.createIcons();
        const firebaseConfig = { 
            apiKey: "AIzaSyCSg9tH4E-71u8b3oFf5j9pDvhoNHZYnZg", 
            authDomain: "invoicely-52db9.firebaseapp.com", 
            projectId: "invoicely-52db9", 
            storageBucket: "invoicely-52db9.firebasestorage.app", 
            messagingSenderId: "512282448037", 
            appId: "1:512282448037:web:ad9600a2aa477c3533fd4c" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allInvoices = [], currentFilter = 'all', activeId = null;

        // --- NAVIGATION LOGIC (SMOOTH TRANSITIONS) ---
        function showPage(p) {
            const views = ['dashboardView', 'reportsView', 'toolsView'];
            
            // Hide all first
            views.forEach(v => {
                const el = document.getElementById(v);
                el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 200);
            });

            // Show target
            const target = document.getElementById(p + 'View');
            target.style.display = 'block';
            // Slight delay to allow display:block to render before opacity transition
            requestAnimationFrame(() => target.classList.add('active'));
            
            // Update Icons
            document.getElementById('nav-dash').classList.replace('text-red-600', 'text-slate-400');
            document.getElementById('nav-report').classList.replace('text-red-600', 'text-slate-400');
            document.getElementById('nav-tools').classList.replace('text-red-600', 'text-slate-400');
            
            if(p === 'dashboard') { document.getElementById('nav-dash').classList.replace('text-slate-400', 'text-red-600'); updateDashboard(); }
            if(p === 'reports') { document.getElementById('nav-report').classList.replace('text-slate-400', 'text-red-600'); closeSubReport(); }
            if(p === 'tools') { document.getElementById('nav-tools').classList.replace('text-slate-400', 'text-red-600'); closeSubTool(); }
            
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // --- SUB MENUS ---
        function openSubReport(t) {
            document.getElementById('dataMenu').classList.add('hidden');
            if(t==='performance'){ document.getElementById('performanceContainer').classList.remove('hidden'); generateReport(); }
            else { document.getElementById('profitContainer').classList.remove('hidden'); generateProfitReport(); }
        }
        function closeSubReport() {
            document.getElementById('performanceContainer').classList.add('hidden');
            document.getElementById('profitContainer').classList.add('hidden');
            document.getElementById('dataMenu').classList.remove('hidden');
        }
        function openSubTool(t) {
            document.getElementById('toolsMenu').classList.add('hidden');
            if(t==='receipt') document.getElementById('toolReceiptContainer').classList.remove('hidden');
            else { 
                document.getElementById('toolTrackContainer').classList.remove('hidden'); 
                document.getElementById('trackResult').classList.add('hidden'); 
                document.getElementById('trackEmpty').classList.remove('hidden');
                document.getElementById('toolTrackPhone').value='';
            }
        }
        function closeSubTool() {
            document.getElementById('toolReceiptContainer').classList.add('hidden');
            document.getElementById('toolTrackContainer').classList.add('hidden');
            document.getElementById('toolsMenu').classList.remove('hidden');
        }

        // --- CORE: ADD ITEM LOGIC (STABLE) ---
        function createItemRow(d = {}) {
            return `
            <div class="item-entry bg-white p-3 rounded-2xl border border-slate-200 relative fade-enter group mb-3 shadow-sm">
                <button onclick="this.closest('.item-entry').remove(); calculateTotal();" class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full w-6 h-6 shadow-md border-2 border-white flex items-center justify-center active:scale-90 z-10"><i data-lucide="x" class="w-3 h-3"></i></button>
                
                <div class="space-y-2 mb-2">
                    <input type="text" class="item-name w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs font-bold outline-none focus:bg-white focus:border-slate-400 transition-colors" placeholder="Item Name (e.g LCD Screen)" value="${d.name || ''}">
                    <textarea class="item-desc w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-[10px] font-medium outline-none focus:bg-white focus:border-slate-400 transition-colors resize-none h-16" placeholder="Description / Issues / Remarks">${d.description || ''}</textarea>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <div class="float-input-group"><input type="number" oninput="calculateTotal()" class="qty w-full bg-slate-50 border border-slate-200 rounded-xl px-1 text-center font-bold text-[10px] outline-none font-num" value="${d.qty || 1}"><label class="w-full text-center left-0">Qty</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="kos w-full bg-slate-50 border border-slate-200 rounded-xl px-1 text-center font-bold text-[10px] outline-none font-num" value="${d.kos || ''}"><label class="w-full text-center left-0">Sell</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" class="modal-price w-full bg-slate-50 border border-red-100 rounded-xl px-1 text-center font-bold text-[10px] text-rose-500 outline-none font-num" value="${d.modal || ''}"><label class="w-full text-center left-0 text-rose-300">Cost</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="discount w-full bg-slate-50 border border-blue-100 rounded-xl px-1 text-center font-bold text-[10px] text-blue-500 outline-none font-num" value="${d.discount || ''}"><label class="w-full text-center left-0 text-blue-300">Disc</label></div>
                </div>
            </div>`;
        }

        function addRow() {
            const container = document.getElementById('itemRowsContainer');
            container.insertAdjacentHTML('beforeend', createItemRow());
            lucide.createIcons();
            const scrollParent = container.parentElement;
            scrollParent.scrollTo({ top: scrollParent.scrollHeight, behavior: 'smooth' });
        }

        function calculateTotal() {
            let t = 0;
            document.querySelectorAll('.item-entry').forEach(r => {
                const q = parseFloat(r.querySelector('.qty').value)||0;
                const k = parseFloat(r.querySelector('.kos').value)||0;
                const d = parseFloat(r.querySelector('.discount').value)||0;
                t += (q * k) - d;
            });
            document.getElementById('grandTotal').innerText = t.toFixed(2);
        }

        // --- PDF GENERATOR (ENTERPRISE UPGRADE) ---
        function generateInvoicePDF(inv) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;

            // --- HEADER ---
            doc.setFillColor(15, 23, 42); // Slate 900
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Logo Text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("NASZEX CLOUD", 15, 20);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Professional GSM Service Center", 15, 26);
            
            // Company Info (Right Side Header)
            doc.setFontSize(9);
            doc.text("Tasek Gelugor, Penang", pageWidth - 15, 18, { align: "right" });
            doc.text("SSM: PG05XXXXX-T", pageWidth - 15, 23, { align: "right" }); // Placeholder SSM
            doc.text("Contact: 01X-XXXXXXX", pageWidth - 15, 28, { align: "right" });

            // --- INVOICE DETAILS ---
            doc.setTextColor(30, 41, 59); // Slate 800
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("OFFICIAL RECEIPT", 15, 55);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Invoice No: ${inv.invoiceNo}`, 15, 62);
            doc.text(`Date: ${formatDate(inv.createdAt, true)}`, 15, 67);
            
            // Status Badge Logic for PDF
            const statusColor = inv.status === 'paid' ? [22, 163, 74] : [220, 38, 38];
            doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
            doc.setFont("helvetica", "bold");
            doc.text(`STATUS: ${inv.status.toUpperCase()}`, 15, 75);

            // --- CUSTOMER DETAILS ---
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("BILL TO:", 120, 62);
            doc.setFont("helvetica", "normal");
            doc.text(inv.customerName, 120, 67);
            doc.text(inv.customerPhone, 120, 72);

            // --- TABLE ---
            const rows = (inv.items||[]).map(x => [
                x.name, 
                x.description || '-', 
                x.qty, 
                `RM ${parseFloat(x.kos).toFixed(2)}`, 
                `RM ${parseFloat(x.discount).toFixed(2)}`, 
                `RM ${((x.qty*x.kos)-x.discount).toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: 85,
                head: [['Item Name', 'Description', 'Qty', 'Unit Price', 'Disc.', 'Total']],
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 3, valign: 'middle' },
                columnStyles: { 0: { fontStyle: 'bold' } },
                alternateRowStyles: { fillColor: [241, 245, 249] }
            });

            // --- TOTAL CALCULATION ---
            let finalY = doc.lastAutoTable.finalY + 10;
            
            // Draw Total Box
            doc.setFillColor(248, 250, 252);
            doc.setDrawColor(226, 232, 240);
            doc.roundedRect(120, finalY, 75, 25, 2, 2, 'FD');

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(15, 23, 42);
            doc.text(`GRAND TOTAL`, 125, finalY + 10);
            doc.text(`RM ${parseFloat(inv.total).toFixed(2)}`, 190, finalY + 10, { align: "right" });
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 116, 139);
            doc.text(`Warranty: ${inv.warranty || 'N/A'}`, 125, finalY + 20);

            // --- TERMS & CONDITIONS (FOOTER) ---
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(7);
            doc.setTextColor(148, 163, 184);
            
            const terms = [
                "TERMS & CONDITIONS:",
                "1. Warranty covers replaced parts only and does not cover physical damage or liquid damage.",
                "2. NASZEX Cloud is not responsible for any data loss during repair. Please backup data beforehand.",
                "3. Devices not collected within 3 months will be disposed of without prior notice.",
                "4. Goods sold are not refundable."
            ];
            
            let termY = pageHeight - 30;
            terms.forEach(term => {
                doc.text(term, 15, termY);
                termY += 4;
            });

            doc.save(`Invoice-${inv.invoiceNo}.pdf`);
        }

        // --- DASHBOARD RENDERER (DEBOUNCED) ---
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                updateDashboard(document.getElementById('searchInput').value);
            }, 300);
        }

        function updateDashboard(search = "") {
            const container = document.getElementById('invoiceContainer');
            const now = new Date();
            let mPaid=0, mPending=0, mJobs=0;

            allInvoices.forEach(i => {
                const d = i.createdAt?.toDate ? i.createdAt.toDate() : new Date();
                if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                    mJobs++;
                    if(i.status === 'paid') mPaid += parseFloat(i.total); else mPending += parseFloat(i.total);
                }
            });

            document.getElementById('stat-month-paid').innerText = Math.round(mPaid);
            document.getElementById('stat-month-pending').innerText = Math.round(mPending);
            document.getElementById('stat-month-jobs').innerText = mJobs;

            let list = allInvoices.filter(i => {
                if(currentFilter !== 'all' && i.status !== currentFilter) return false;
                if(search) {
                    const q = search.toLowerCase();
                    return (i.customerName||"").toLowerCase().includes(q) || (i.customerPhone||"").includes(q) || (i.invoiceNo||"").toLowerCase().includes(q);
                }
                return true;
            });

            container.innerHTML = list.length ? '' : `<div class="py-10 text-center opacity-50"><p class="text-[10px] font-black uppercase text-slate-400">No Records Found</p></div>`;

            list.forEach(i => {
                const isPaid = i.status === 'paid';
                const statusColor = isPaid ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
                const repairMap = {'Received':'bg-slate-200','Waiting':'bg-amber-200','Diagnosis':'bg-purple-200','Repairing':'bg-blue-200','Ready':'bg-emerald-400 animate-pulse','Collected':'bg-slate-800 text-white'};
                
                const html = `
                <div onclick="openActionMenu('${i.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-all flex justify-between items-center group fade-enter mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${repairMap[i.repairStatus]||'bg-slate-100'} flex items-center justify-center text-[10px] font-black uppercase shadow-inner">
                            ${(i.repairStatus||'NEW').substring(0,3)}
                        </div>
                        <div>
                            <h4 class="text-[11px] font-black uppercase text-slate-800 leading-none">${i.customerName}</h4>
                            <p class="text-[9px] font-bold text-slate-400 mt-1 font-num">${i.invoiceNo} â€¢ ${formatDate(i.createdAt)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[13px] font-black italic text-slate-800 font-num">RM ${Math.round(i.total)}</p>
                        <span class="text-[8px] font-bold uppercase px-2 py-0.5 rounded ${statusColor}">${i.status}</span>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- TRACKER LOGIC ---
        function trackStatus() {
            const p = document.getElementById('toolTrackPhone').value.trim();
            if(!p) return alert("Enter Phone Number");
            
            const match = allInvoices.filter(i => i.customerPhone.includes(p)).sort((a,b)=>b.createdAt-a.createdAt)[0];
            if(!match) return alert("No record found.");

            document.getElementById('trackEmpty').classList.add('hidden');
            document.getElementById('trackResult').classList.remove('hidden');
            
            document.getElementById('trName').innerText = match.customerName;
            document.getElementById('trNo').innerText = match.invoiceNo;
            document.getElementById('trDevice').innerText = (match.items||[]).map(x=>x.name).join(", ") || "General Service";

            const stages = ['Received', 'Waiting', 'Diagnosis', 'Repairing', 'Ready', 'Collected'];
            let html = '', passed = true;
            stages.forEach(s => {
                if(s === match.repairStatus) passed = false;
                const active = passed || s === match.repairStatus;
                
                html += `
                <div class="timeline-item ${active?'active':''}">
                    <div class="timeline-dot"></div>
                    <p class="text-[10px] font-bold ${active?'text-slate-900':'text-slate-300'} uppercase">${s}</p>
                    ${s===match.repairStatus ? '<span class="text-[8px] text-emerald-600 font-bold italic block mt-0.5">Current Phase</span>' : ''}
                </div>`;
            });
            document.getElementById('timelineContainer').innerHTML = html;
        }

        // --- UTILS ---
        function handleTools(act) {
            const p = document.getElementById('toolReceiptPhone').value;
            if(!p) return alert("Enter Phone");
            const match = allInvoices.filter(i => i.customerPhone.includes(p)).sort((a,b)=>b.createdAt-a.createdAt)[0];
            if(!match) return alert("No record.");
            
            if(act === 'whatsapp') window.open(`https://wa.me/60${p.replace(/^0+/,'')}`);
            else generateInvoicePDF(match);
        }
        
        function formatDate(ts, full=false) {
            if(!ts) return '--/--';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            if(full) return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
            return `${d.getDate()}/${d.getMonth()+1}`;
        }
        
        // --- DATA CRUD ---
        async function saveAndGenerate() {
            const btn = document.getElementById('btnSave');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...`;
            
            const n = document.getElementById('custName').value, p = document.getElementById('custPhone').value;
            if(!n || !p) { alert("Please enter Name & Phone!"); btn.innerHTML = originalText; return; }

            const items = [];
            document.querySelectorAll('.item-entry').forEach(r => {
                const name = r.querySelector('.item-name').value;
                if(name) {
                    items.push({
                        name: name, 
                        description: r.querySelector('.item-desc').value,
                        qty: parseFloat(r.querySelector('.qty').value)||1,
                        kos: parseFloat(r.querySelector('.kos').value)||0,
                        modal: parseFloat(r.querySelector('.modal-price').value)||0,
                        discount: parseFloat(r.querySelector('.discount').value)||0
                    });
                }
            });

            const data = {
                customerName: n, customerPhone: p,
                warranty: document.getElementById('warranty').value,
                status: document.getElementById('initialStatus').value,
                total: document.getElementById('grandTotal').innerText,
                items: items
            };
            
            try {
                const editId = document.getElementById('editId').value;
                if(editId) {
                    await db.collection("invoices").doc(editId).update(data);
                } else {
                    const lastNo = allInvoices.reduce((max, i) => Math.max(max, parseInt(i.invoiceNo?.split('-')[1]||0)), 0);
                    data.invoiceNo = "NX-" + (lastNo + 1).toString().padStart(4, '0');
                    data.repairStatus = 'Received';
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    if(data.status === 'paid') data.paidAt = data.createdAt;
                    await db.collection("invoices").add(data);
                }
                toggleModal(false);
            } catch(e) { console.error(e); alert("Save failed."); }
            btn.innerHTML = originalText;
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-icon'); btn.classList.add('animate-spin');
            const s = await db.collection("invoices").orderBy("createdAt", "desc").get();
            allInvoices = s.docs.map(d=>({id:d.id, ...d.data()}));
            showPage(localStorage.getItem('naszex_active_page')||'dashboard');
            setTimeout(()=>btn.classList.remove('animate-spin'), 800);
        }

        // Modal Controls
        function toggleModal(show) {
            const m = document.getElementById('invoiceModal');
            if(show) { m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('active')); }
            else { m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 250); }
        }
        function openAddModal() {
            document.getElementById('modalTitle').innerText = "New Job Sheet";
            document.getElementById('editId').value = "";
            document.getElementById('custName').value = "";
            document.getElementById('custPhone').value = "";
            document.getElementById('itemRowsContainer').innerHTML = ""; 
            addRow(); 
            document.getElementById('grandTotal').innerText = "0.00";
            toggleModal(true);
        }
        function openActionMenu(id) {
            activeId = id;
            const i = allInvoices.find(x=>x.id===id);
            document.getElementById('actionTargetName').innerText = i.customerName;
            document.getElementById('updateRepairStatus').value = i.repairStatus || 'Received';
            document.getElementById('actionModal').classList.remove('hidden');
            requestAnimationFrame(()=>document.getElementById('actionModal').classList.add('active'));
            
            const btn = document.getElementById('btnToggleStatus');
            if(i.status === 'paid') {
                 btn.classList.replace('bg-emerald-600', 'bg-slate-900');
                 btn.innerHTML = `<span>Mark Unpaid</span><i data-lucide="x-circle" class="w-4 h-4 text-rose-400"></i>`;
            } else {
                 btn.classList.replace('bg-slate-900', 'bg-emerald-600');
                 btn.innerHTML = `<span>Mark Paid</span><i data-lucide="check-circle" class="w-4 h-4 text-white"></i>`;
            }
            btn.onclick = async () => {
                await db.collection("invoices").doc(id).update({status: i.status==='paid'?'outstanding':'paid'});
                closeActionMenu();
            };
            lucide.createIcons();
        }
        
        function handleAction(type) {
            if(type === 'edit') {
                const i = allInvoices.find(x=>x.id===activeId);
                document.getElementById('editId').value = activeId;
                document.getElementById('modalTitle').innerText = "Modify Job";
                document.getElementById('custName').value = i.customerName;
                document.getElementById('custPhone').value = i.customerPhone;
                document.getElementById('warranty').value = i.warranty || 'No Warranty';
                document.getElementById('initialStatus').value = i.status;
                const cont = document.getElementById('itemRowsContainer');
                cont.innerHTML = "";
                (i.items||[]).forEach(it => { cont.insertAdjacentHTML('beforeend', createItemRow(it)); });
                calculateTotal();
                toggleModal(true);
            }
            if(type === 'delete' && confirm("Delete record?")) db.collection("invoices").doc(activeId).delete();
            if(type === 'getlink') { navigator.clipboard.writeText(window.location.origin + "/view?id=" + activeId); alert("Link Copied"); }
            closeActionMenu();
        }
        
        async function updateLiveStatus(id, val) { await db.collection("invoices").doc(id).update({repairStatus: val}); }
        function closeActionMenu() { const m = document.getElementById('actionModal'); m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 250); }

        // Generators
        function generateReport() {
            const tb = document.getElementById('reportTableBody'), mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];
            let h = "";
            mo.forEach((m, i) => {
                const monthly = allInvoices.filter(inv => { const d = inv.createdAt?.toDate ? inv.createdAt.toDate() : new Date(); return d.getMonth() === i && d.getFullYear() === 2026; });
                const pS = monthly.reduce((s, inv) => inv.status === 'paid' ? s + parseFloat(inv.total) : s, 0);
                if (monthly.length > 0) h += `<tr class="border-b border-slate-50 last:border-0"><td class="pl-6 py-4 text-slate-500 uppercase font-bold text-[9px]">${m}</td><td class="text-center font-num text-slate-400">${monthly.length}</td><td class="text-right pr-6 text-emerald-600 italic font-black font-num">RM ${Math.round(pS)}</td></tr>`;
            });
            tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-slate-300 text-[10px]">No Data</td></tr>';
        }

        function generateProfitReport() {
            const tb = document.getElementById('profitTableBody'), mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];
            let h = "", totalNett = 0;
            mo.forEach((m, i) => {
                const monthly = allInvoices.filter(inv => { const d = inv.createdAt?.toDate ? inv.createdAt.toDate() : new Date(); return d.getMonth() === i && d.getFullYear() === 2026 && inv.status === 'paid'; });
                let mModal = 0, mRev = 0;
                monthly.forEach(inv => { mRev += parseFloat(inv.total); (inv.items || []).forEach(it => { mModal += (parseFloat(it.modal)||0) * (parseFloat(it.qty)||1); }); });
                const mProfit = mRev - mModal; totalNett += mProfit;
                if(mRev > 0) h += `<tr class="border-b border-slate-50 last:border-0"><td class="pl-6 py-4 text-slate-500 uppercase font-bold text-[9px]">${m}</td><td class="text-center text-rose-500 font-bold font-num text-[10px]">RM ${Math.round(mModal)}</td><td class="text-right pr-6 text-emerald-600 italic font-black font-num">RM ${Math.round(mProfit)}</td></tr>`;
            });
            tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-slate-300 text-[10px]">No Data</td></tr>';
            document.getElementById('total-net-profit').innerText = `RM ${Math.round(totalNett)}`;
        }

        // Init
        db.collection("invoices").orderBy("createdAt", "desc").onSnapshot(s => {
            allInvoices = s.docs.map(d=>({id:d.id, ...d.data()}));
            if(localStorage.getItem('naszex_active_page') === 'dashboard') updateDashboard();
        });
        window.onload = refreshData;
    </script>
</body>
</html>
